<!DOCTYPE html>
<html>
<head>
  <title>Pivot Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212; /* dark background */
      color: #e0e0e0;            /* light text */
    }
    h2, h3 { text-align: center; color: #ffffff; }
    table {
      border-collapse: collapse;
      width: 95%;
      margin: 20px auto;
      background-color: #1e1e1e; /* dark gray table */
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #333; color: #fff; }
    .red { background-color: #ff4c4c; color: #000; }     /* Pivot below low -> price above pivot */
    .green { background-color: #4caf50; color: #000; }   /* Pivot above high -> price below pivot */
    .yellow { background-color: #ffeb3b; color: #000; }  /* Pivot within today's range */
    .gray { background-color: #999; color: #000; }       /* Missing data indicator */
    .legend { width: 95%; margin: 10px auto; font-size: 14px; color: #ccc; }
    .legend span { display: inline-block; margin-right: 15px; padding: 3px 8px; border-radius: 3px; }
    .legend .red { background-color: #ff4c4c; }
    .legend .green { background-color: #4caf50; }
    .legend .yellow { background-color: #ffeb3b; }
    .legend .gray { background-color: #999; }
    .note { width: 95%; margin: 5px auto; font-size: 12px; color: #aaa; text-align: center; }
  </style>
</head>
<body>
  <h2>Pivot Dashboard</h2>
  <h3 id="timestamp"></h3>

  <div class="legend">
    <span class="red">Pivot &lt; Today Low (price stayed above pivot)</span>
    <span class="green">Pivot &gt; Today High (price stayed below pivot)</span>
    <span class="yellow">Pivot within Today High–Low (price traversed pivot zone)</span>
    <span class="gray">N/A or missing</span>
  </div>

  <h2>Phase 1: Pre-Close Dashboard</h2>
  <table id="phase1">
    <tr><th>Ticker</th><th>Yesterday Pivot</th><th>Yesterday OHLC</th><th>Today High</th><th>Today Low</th><th>Status</th><th>Source</th></tr>
  </table>

  <h2>Phase 2: Pre-Open Dashboard</h2>
  <table id="phase2">
    <tr><th>Ticker</th><th>Yesterday Pivot</th><th>Pre-Market / Current Price</th><th>Source</th></tr>
  </table>

  <div class="note">Alpha Vantage free tier is 5 calls/minute. This page throttles requests automatically.</div>

<script>
const tickers = ["NVDA","AMD","TSLA","META","AVGO","NFLX","ADBE","NOW","SHOP","SNOW","AAPL","AMZN"];
const alphaKey = "YOUR_ALPHA_KEY";   // <-- insert your Alpha Vantage key
const finnhubKey = "YOUR_FINNHUB_KEY"; // optional fallback (kept for future use)
document.getElementById("timestamp").innerText = "Last refreshed: " + new Date().toLocaleString();

/*
  We need:
  - Yesterday OHLC for pivot: TIME_SERIES_DAILY (Alpha)
  - Today's High/Low: GLOBAL_QUOTE (Alpha)
  - Pre-market/current price: GLOBAL_QUOTE "05. price" (Alpha). If not available, we’ll show N/A.

  Rate limiting:
  - 2 calls per ticker (DAILY + GLOBAL_QUOTE) -> 24 calls for 12 tickers.
  - We throttle to ~5 per minute using a simple queue and delay.
*/

const delayMs = 12500; // ~12.5s between requests ≈ 4-5 calls/min

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function fetchDaily(ticker) {
  const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${ticker}&apikey=${alphaKey}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const series = data["Time Series (Daily)"];
    if (!series) return null;

    const dates = Object.keys(series).sort((a,b) => new Date(b) - new Date(a));
    // latest (today or most recent trading day) and previous day
    const latest = series[dates[0]];
    const prev = series[dates[1]]; // yesterday
    if (!prev) return null;

    const yHigh = parseFloat(prev["2. high"]);
    const yLow  = parseFloat(prev["3. low"]);
    const yClose = parseFloat(prev["4. close"]);
    const pivot = (yHigh + yLow + yClose) / 3;

    return { yHigh, yLow, yClose, pivot, source: "AlphaVantage DAILY" };
  } catch (e) {
    console.warn("Alpha DAILY failed for", ticker, e);
    return null;
  }
}

async function fetchQuote(ticker) {
  const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${alphaKey}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const q = data["Global Quote"];
    if (!q) return null;
    const todayHigh = parseFloat(q["03. high"]);
    const todayLow  = parseFloat(q["04. low"]);
    const price     = q["05. price"] ? parseFloat(q["05. price"]) : null;
    return { todayHigh, todayLow, price, source: "AlphaVantage QUOTE" };
  } catch (e) {
    console.warn("Alpha QUOTE failed for", ticker, e);
    return null;
  }
}

async function buildDashboard() {
  const phase1 = document.getElementById("phase1");
  const phase2 = document.getElementById("phase2");

  for (let i = 0; i < tickers.length; i++) {
    const t = tickers[i];

    // Throttle before each pair of requests
    if (i > 0) await sleep(delayMs);

    // Fetch yesterday OHLC for pivot
    const daily = await fetchDaily(t);
    if (!daily) {
      phase1.innerHTML += `<tr><td>${t}</td><td colspan="6" class="gray">No daily data returned (Alpha)</td></tr>`;
      phase2.innerHTML += `<tr><td>${t}</td><td class="gray">N/A</td><td class="gray">N/A</td><td>AlphaVantage</td></tr>`;
      continue;
    }

    // Throttle before second request
    await sleep(delayMs);

    // Fetch today's high/low and pre-market/current price
    const quote = await fetchQuote(t);
    if (!quote) {
      phase1.innerHTML += `<tr><td>${t}</td><td>${daily.pivot.toFixed(2)}</td><td>${daily.yHigh.toFixed(2)} / ${daily.yLow.toFixed(2)} / ${daily.yClose.toFixed(2)}</td><td class="gray">N/A</td><td class="gray">N/A</td><td class="gray">No quote</td><td>${daily.source}</td></tr>`;
      phase2.innerHTML += `<tr><td>${t}</td><td>${daily.pivot.toFixed(2)}</td><td class="gray">N/A</td><td>${daily.source}</td></tr>`;
      continue;
    }

    // Phase 1 coloring
    let statusClass = "yellow";
    let statusText = "Within Range";
    const th = quote.todayHigh;
    const tl = quote.todayLow;

    // If today’s high/low missing, mark gray
    if (!isFinite(th) || !isFinite(tl)) {
      statusClass = "gray";
      statusText = "Missing today range";
    } else {
      if (daily.pivot < tl) { statusClass = "red"; statusText = "Pivot < Today Low"; }
      else if (daily.pivot > th) { statusClass = "green"; statusText = "Pivot > Today High"; }
      else { statusClass = "yellow"; statusText = "Pivot within Today High–Low"; }
    }

    // Phase 1 row
    phase1.innerHTML += `
      <tr>
        <td>${t}</td>
        <td>${daily.pivot.toFixed(2)}</td>
        <td>${daily.yHigh.toFixed(2)} / ${daily.yLow.toFixed(2)} / ${daily.yClose.toFixed(2)}</td>
        <td>${isFinite(th) ? th.toFixed(2) : "N/A"}</td>
        <td>${isFinite(tl) ? tl.toFixed(2) : "N/A"}</td>
        <td class="${statusClass}">${statusText}</td>
        <td>${daily.source} + ${quote.source}</td>
      </tr>
    `;

    // Phase 2 row (pre-market/current price)
    const pm = isFinite(quote.price) ? quote.price.toFixed(2) : "N/A";
    const pmClass = isFinite(quote.price) ? "" : "gray";

    phase2.innerHTML += `
      <tr>
        <td>${t}</td>
        <td>${daily.pivot.toFixed(2)}</td>
        <td class="${pmClass}">${pm}</td>
        <td>${quote.source}</td>
      </tr>
    `;
  }
}

buildDashboard();
</script>
</body>
</html>

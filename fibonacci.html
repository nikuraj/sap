<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camarilla Levels and Alerts</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #121212; color: #e0e0e0; }
    .container { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 40px; }
    table { border-collapse: collapse; margin: 10px 0; width: 220px; }
    th, td { border: 1px solid #444; padding: 6px; text-align: center; }
    th { background: #333; color: #fff; }
    .pivot { background: #444; font-weight: bold; }
    .resistance { background: #552222; }
    .support { background: #225522; }
    .price { background: #444466; font-weight: bold; color: #fff; }
    .highlight { background-color: yellow !important; color: black !important; }
    .cpr { background: #4a4a2a; } /* Style for BC, TC */

    #alertsWrapper {
      background: #1e1e1e; padding: 10px;
      margin-top: 30px;
    }
    #alertsTable { border-collapse: collapse; width: 100%; }
    #alertsTable th, #alertsTable td {
      border: 1px solid #444; padding: 6px; text-align: center; font-size: 12px;
    }
    #alertsTable th { background: #222; color: #fff; }

    .tv-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <div class="container" id="tables"></div>

  <!-- TradingView Widgets -->
  <div class="tv-grid">
    <div id="tv_aapl"></div>
    <div id="tv_amd"></div>
    <div id="tv_nvda"></div>
    <div id="tv_tsla"></div>
  </div>

  <div id="alertsWrapper">
    <h2>Alerts Log</h2>
    <table id="alertsTable">
      <tr><th>Ticker</th><th>Level</th><th>Price</th><th>Time</th></tr>
    </table>
    <button onclick="resetAlerts()">Clear Alerts</button>
  </div>

  <script type="text/javascript" src="s3.tradingview.com"></script>
  <script>
    // TradingView charts
    new TradingView.widget({ "width": 480, "height": 320, "symbol": "NASDAQ:AAPL", "interval": "D", "theme": "dark", "container_id": "tv_aapl" });
    new TradingView.widget({ "width": 480, "height": 320, "symbol": "NASDAQ:AMD", "interval": "D", "theme": "dark", "container_id": "tv_amd" });
    new TradingView.widget({ "width": 480, "height": 320, "symbol": "NASDAQ:NVDA", "interval": "D", "theme": "dark", "container_id": "tv_nvda" });
    new TradingView.widget({ "width": 480, "height": 320, "symbol": "NASDAQ:TSLA", "interval": "D", "theme": "dark", "container_id": "tv_tsla" });

    const tickers = ["AAPL","AMD","NVDA","TSLA"];
    const firedAlerts = new Set();

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    function proxyFetch(url) {
      const proxyUrl = "api.allorigins.win" + encodeURIComponent(url);
      return fetch(proxyUrl).then(res => res.json());
    }

    // Function updated with TC, BC, and PreviousDayLow
    function calculateLevels(high, low, close) {
      const pp = (high + low + close) / 3;
      const bc = (high + low) / 2; // Bottom Central Pivot
      const tc = (2 * pp) - bc;    // Top Central Pivot
      const range = high - low;
      return {
        Pivot: pp.toFixed(2),
        BC: bc.toFixed(2),
        TC: tc.toFixed(2),
        PreviousDayLow: low.toFixed(2), // Previous Day Low
        R1: (pp + range * 0.382).toFixed(2),
        R2: (pp + range * 0.618).toFixed(2),
        R3: (pp + range * 1.000).toFixed(2),
        R4: (pp + range * 1.382).toFixed(2),
        R5: (pp + range * 1.618).toFixed(2),
        R6: (pp + range * 2.000).toFixed(2),
        S1: (pp - range * 0.382).toFixed(2),
        S2: (pp - range * 0.618).toFixed(2),
        S3: (pp - range * 1.000).toFixed(2),
        S4: (pp - range * 1.382).toFixed(2),
        S5: (pp - range * 1.618).toFixed(2),
        S6: (pp - range * 2.000).toFixed(2),
      };
    }

    function renderTable(symbol, levels) {
      let entries = Object.entries(levels).sort((a,b) => parseFloat(b[1]) - parseFloat(a[1]));
      let html = `<table id="table_${symbol}"><tr><th>${symbol}</th><th>Price</th></tr>`;
      for (const [key, value] of entries) {
        let cls = "";
        if (key === "Pivot") cls = "pivot";
        else if (key === "BC" || key === "TC") cls = "cpr"; // Added CSS class for CPR levels
        else if (key.startsWith("R")) cls = "resistance";
        else if (key.startsWith("S")) cls = "support";
        html += `<tr class="${cls}"><td>${key}</td><td>${value}</td></tr>`;
      }
      html += "</table>";
      return html;
    }

    async function fetchOHLC(symbol) {
      const url = `query1.finance.yahoo.com{symbol}?range=5d&interval=1d`;
      const data = await proxyFetch(url);
      const result = data.chart.result[0];
      const ohlc = result.indicators.quote[0];
      const idx = result.timestamp.length - 2; // last completed day
      return { high: ohlc.high[idx], low: ohlc.low[idx], close: ohlc.close[idx] };
    }

    async function fetchCurrentPrice(symbol) {
      const url = `query1.finance.yahoo.com{symbol}?interval=1m&range=1d`;
      const data = await proxyFetch(url);
      const result = data?.chart?.result?.[0];
      const closes = result?.indicators?.quote?.[0]?.close || [];
      for (let i = closes.length - 1; i >= 0; i--) {
        if (closes[i] != null) return closes[i];
      }
      return null;
    }

    async function updateSlider() {
      for (const t of tickers) {
        try {
          const ohlc = await fetchOHLC(t);
          const levels = calculateLevels(ohlc.high, ohlc.low, ohlc.close);
          const price = await fetchCurrentPrice(t);
          if (price == null) continue;

          if (!document.getElementById(`table_${t}`)) {
            document.getElementById("tables").innerHTML += renderTable(t, levels);
          }

          const table = document.getElementById(`table_${t}`);
          if (!table) continue;

          const oldRow = document.getElementById(`priceRow_${t}`);
          if (oldRow) oldRow.remove();

          let entries = Object.entries(levels).sort((a,b) => parseFloat(b[1]) - parseFloat(a[1]));
          let inserted = false;
          for (let i = 0; i < entries.length; i++) {
            const levelPrice = parseFloat(entries[i][1]);
            const nextPrice = i+1 < entries.length ? parseFloat(entries[i+1][1]) : null;
            if (price <= levelPrice && (nextPrice === null || price > nextPrice)) {
              const row = table.insertRow(i+2);
              row.id = `priceRow_${t}`;
              row.className = "price";
              row.innerHTML = `<td>Current</td><td>${Number(price).toFixed(2)}</td>`;
              inserted = true;
              break;
            }
          }
          if (!inserted) {
            const row = table.insertRow(1);
            row.id = `priceRow_${t}`;
            row.className = "price";
            row.innerHTML = `<td>Current</td><td>${Number(price).toFixed(2)}</td>`;
          }

          const rows = table.rows;
          for (let r = 1; r < rows.length; r++) {
                       const row = rows[r];
            if (row.id === `priceRow_${t}`) continue;
            const cell = row.cells[1];
            if (!cell) continue;
            const levelPrice = parseFloat(cell.innerText);
            const levelName = row.cells[0].innerText;
            if (!isNaN(levelPrice)) {
              const alertKey = `${t}_${levelName}`;
              if (Math.abs(price - levelPrice) <= 1.00) {
                row.classList.add("highlight");
                if (!firedAlerts.has(alertKey)) {
                  firedAlerts.add(alertKey);
                  const alertsTable = document.getElementById("alertsTable");
                  const newRow = alertsTable.insertRow(-1);
                  const timestamp = new Date().toLocaleTimeString();
                  newRow.innerHTML = `<td>${t}</td><td>${levelName}</td><td>${levelPrice.toFixed(2)}</td><td>${timestamp}</td>`;
                  if ("Notification" in window && Notification.permission === "granted") {
                    new Notification(`ALERT: ${t}`, {
                      body: `Price ${Number(price).toFixed(2)} near ${levelName} (${levelPrice.toFixed(2)})`,
                      icon: "static.thenounproject.com"
                    });
                  }
                }
              } else {
                row.classList.remove("highlight");
              }
            }
          }
        } catch (err) {
          console.error("Error updating", t, err);
        }
      }
    }

    // Function to clear alerts log
    function resetAlerts() {
      firedAlerts.clear();
      const alertsTable = document.getElementById("alertsTable");
      // Keep the header row intact
      alertsTable.innerHTML = "<tr><th>Ticker</th><th>Level</th><th>Price</th><th>Time</th></tr>";
    }
    
    // Start the update loop when the page loads
    document.addEventListener("DOMContentLoaded", () => {
      (async function loop() {
        await updateSlider();
        setTimeout(loop, 5000); // refresh every 5 seconds
      })();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fibonacci Pivot Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #121212; color: #e0e0e0; }
    h2 { margin-bottom: 10px; }
    .container { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 40px; }
    table { border-collapse: collapse; margin: 10px 0; width: 280px; }
    th, td { border: 1px solid #444; padding: 6px; text-align: center; }
    th { background: #333; color: #fff; }
    .pivot { background: #444; font-weight: bold; }
    .resistance { background: #552222; }
    .support { background: #99cc99; } /* light green */
    .price { background: #444466; font-weight: bold; color: #fff; }
    .highlight { background-color: #ffff99 !important; color: black !important; } /* lighter yellow */

    .todayHigh { background: #004400; color: #fff; font-weight: bold; }
    .todayLow  { background: #440000; color: #fff; font-weight: bold; }
    .band { background: #333366; }
    .pivotGreen { background: #006600 !important; color: #fff; }
    .pivotRed   { background: #660000 !important; color: #fff; }

    #alertsWrapper { background: #1e1e1e; padding: 10px; margin-top: 30px; }
    #alertsTable { border-collapse: collapse; width: 100%; }
    #alertsTable th, #alertsTable td {
      border: 1px solid #444; padding: 6px; text-align: center; font-size: 12px;
    }
    #alertsTable th { background: #222; color: #fff; }

    .tv-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2 id="dateHeader"></h2>
  <div class="container" id="tables"></div>

  <!-- TradingView Widgets -->
  <div class="tv-grid">
    <div id="tv_aapl"></div>
    <div id="tv_amd"></div>
    <div id="tv_nvda"></div>
    <div id="tv_tsla"></div>
  </div>

  <div id="alertsWrapper">
    <h2>Alerts Log</h2>
    <table id="alertsTable">
      <tr><th>Ticker</th><th>Level</th><th>Price</th><th>Time</th></tr>
    </table>
  </div>

  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    // TradingView charts
    new TradingView.widget({ width: 480, height: 320, symbol: "NASDAQ:AAPL", interval: "D", theme: "dark", container_id: "tv_aapl" });
    new TradingView.widget({ width: 480, height: 320, symbol: "NASDAQ:AMD",  interval: "D", theme: "dark", container_id: "tv_amd" });
    new TradingView.widget({ width: 480, height: 320, symbol: "NASDAQ:NVDA", interval: "D", theme: "dark", container_id: "tv_nvda" });
    new TradingView.widget({ width: 480, height: 320, symbol: "NASDAQ:TSLA", interval: "D", theme: "dark", container_id: "tv_tsla" });

    const tickers = ["AAPL","AMD","NVDA","TSLA"];
    const firedAlerts = new Set();

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    function proxyFetch(url) {
      const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
      return fetch(proxyUrl).then(res => res.json());
    }

    function safeToFixed(num, digits = 2) {
      const n = Number(num);
      if (!isFinite(n)) return "-";
      return n.toFixed(digits);
    }

    function latestValid(arr) {
      if (!Array.isArray(arr)) return null;
      for (let i = arr.length - 1; i >= 0; i--) {
        const v = arr[i];
        if (v != null && isFinite(v)) return v;
      }
      return null;
    }

    // Fibonacci pivot calculation (yesterday)
    function calculateLevels(high, low, close) {
      const pp = (high + low + close) / 3;
      const range = high - low;
      return {
        Pivot: safeToFixed(pp),
        R1: safeToFixed(pp + range * 0.382),
        R2: safeToFixed(pp + range * 0.618),
        R3: safeToFixed(pp + range * 1.000),
        R4: safeToFixed(pp + range * 1.382),
        R5: safeToFixed(pp + range * 1.618),
        R6: safeToFixed(pp + range * 2.000),
        S1: safeToFixed(pp - range * 0.382),
        S2: safeToFixed(pp - range * 0.618),
        S3: safeToFixed(pp - range * 1.000),
        S4: safeToFixed(pp - range * 1.382),
        S5: safeToFixed(pp - range * 1.618),
        S6: safeToFixed(pp - range * 2.000),
      };
    }

    function renderTable(symbol, levels, todayHigh, todayLow, todayOpen, yesterdayClose) {
      const gap = todayOpen - yesterdayClose;
      const gapText = (gap >= 0 ? "Gap Up: +" : "Gap Down: ") + safeToFixed(gap);

      let allLevels = Object.entries(levels).map(([key, val]) => {
        const num = Number(val);
        let cls = "";
        if (key === "Pivot") cls = "pivot";
        else if (key.startsWith("R")) cls = "resistance";
        else if (key.startsWith("S")) cls = "support";
        return { name: key, value: num, text: safeToFixed(num), cls };
      });

      allLevels.push({ name: "Today Open", value: Number(todayOpen), text: safeToFixed(todayOpen), cls: "" });
      allLevels.push({ name: "Today High", value: Number(todayHigh), text: safeToFixed(todayHigh), cls: "todayHigh" });
      allLevels.push({ name: "Today Low",  value: Number(todayLow),  text: safeToFixed(todayLow),  cls: "todayLow" });

      allLevels = allLevels.filter(l => isFinite(l.value));
      allLevels.sort((a, b) => b.value - a.value);

      let html = `<table id="table_${symbol}"><tr><th>${symbol}</th><th>${gapText}</th></tr>`;
      for (const lvl of allLevels) {
        html += `<tr class="${lvl.cls}"><td>${lvl.name}</td><td>${lvl.text}</td></tr>`;
      }
      html += "</table>";
      return html;
    }

    async function fetchOHLC(symbol) {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=5d&interval=1d`;
      const data = await proxyFetch(url);
      const result = data.chart?.result?.[0];
      const ohlc = result?.indicators?.quote?.[0];
      const idx = result?.timestamp?.length ? result.timestamp.length - 2 : null; // yesterday
      const high = idx != null ? ohlc?.high?.[idx] : null;
      const low  = idx != null ? ohlc?.low?.[idx]  : null;
      const close= idx != null ? ohlc?.close?.[idx]: null;
      if (![high, low, close].every(v => v != null && isFinite(v))) return null;
      return { high, low, close };
    }

        async function fetchTodayOHLC(symbol) {
      // Use intraday 1m feed to get true today's open/high/low
      const url = `https://query1.finance.yahoo.com/v7/finance/chart/${symbol}?interval=1m&range=1d`;
      const data = await proxyFetch(url);
      const result = data?.chart?.result?.[0];
      const ohlc = result?.indicators?.quote?.[0];

      const opens = ohlc?.open || [];
      const highs = ohlc?.high || [];
      const lows  = ohlc?.low  || [];

      const todayOpen = opens.find(v => v != null && isFinite(v));
      const todayHigh = Math.max(...highs.filter(v => v != null && isFinite(v)));
      const todayLow  = Math.min(...lows.filter(v => v != null && isFinite(v)));

      return { open: todayOpen, high: todayHigh, low: todayLow };
    }

    async function fetchCurrentPrice(symbol) {
      const url = `https://query1.finance.yahoo.com/v7/finance/chart/${symbol}?interval=1m&range=1d`;
      const data = await proxyFetch(url);
      const result = data?.chart?.result?.[0];
      const closes = result?.indicators?.quote?.[0]?.close || [];
      return latestValid(closes);
    }

    function ensureTableExists(symbol, html) {
      const el = document.getElementById(`table_${symbol}`);
      if (!el) {
        document.getElementById("tables").innerHTML += html;
      } else {
        el.outerHTML = html;
      }
    }

    async function updateSlider() {
      for (const t of tickers) {
        try {
          const ohlc = await fetchOHLC(t);            // yesterday’s OHLC for pivots
          const todayOHLC = await fetchTodayOHLC(t);  // today’s open/high/low
          const price = await fetchCurrentPrice(t);

          if (!ohlc || !todayOHLC || price == null) continue;

          const levels = calculateLevels(ohlc.high, ohlc.low, ohlc.close);

          // Render or replace table with sorted levels + today’s OHLC + gap
          const tableHtml = renderTable(t, levels, todayOHLC.high, todayOHLC.low, todayOHLC.open, ohlc.close);
          ensureTableExists(t, tableHtml);

          const table = document.getElementById(`table_${t}`);
          if (!table) continue;

          // Insert current price row dynamically
          const oldRow = document.getElementById(`priceRow_${t}`);
          if (oldRow) oldRow.remove();

          let rows = Array.from(table.rows).slice(1); // skip header
          let inserted = false;
          for (let i = 0; i < rows.length; i++) {
            const val = parseFloat(rows[i].cells[1].innerText);
            const nextVal = i+1 < rows.length ? parseFloat(rows[i+1].cells[1].innerText) : null;
            if (!isFinite(val)) continue;
            if (price <= val && (nextVal === null || price > nextVal)) {
              const row = table.insertRow(i+2);
              row.id = `priceRow_${t}`;
              row.className = "price";
              row.innerHTML = `<td>Current</td><td>${safeToFixed(price)}</td>`;
              inserted = true;
              break;
            }
          }
          if (!inserted) {
            const row = table.insertRow(1);
            row.id = `priceRow_${t}`;
            row.className = "price";
            row.innerHTML = `<td>Current</td><td>${safeToFixed(price)}</td>`;
          }

          // Highlight Pivot row based on today’s High/Low
          if (isFinite(todayOHLC.high) && isFinite(todayOHLC.low)) {
            for (let r = 1; r < table.rows.length; r++) {
              const row = table.rows[r];
              if (row.cells[0].innerText === "Pivot") {
                const pivotVal = parseFloat(row.cells[1].innerText);
                if (!isFinite(pivotVal)) break;
                row.classList.remove("pivotGreen", "pivotRed");
                if (todayOHLC.high < pivotVal && todayOHLC.low < pivotVal) {
                  row.classList.add("pivotGreen");
                } else if (todayOHLC.high > pivotVal && todayOHLC.low > pivotVal) {
                  row.classList.add("pivotRed");
                }
                break;
              }
            }
          }

          // Shade band between today’s High and Low
          for (let r = 1; r < table.rows.length; r++) {
            const row = table.rows[r];
            const val = parseFloat(row.cells[1].innerText);
            if (!isFinite(val)) continue;
            if (isFinite(todayOHLC.high) && isFinite(todayOHLC.low) && val <= todayOHLC.high && val >= todayOHLC.low) {
              row.classList.add("band");
            } else {
              row.classList.remove("band");
            }
          }
        } catch (err) {
          console.error("Error updating", t, err);
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Show both dates at top in YYYY-MM-DD
      const today = new Date();
      const formattedToday = today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,"0") + "-" + String(today.getDate()).padStart(2,"0");
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);
      const formattedYesterday = yesterday.getFullYear() + "-" + String(yesterday.getMonth()+1).padStart(2,"0") + "-" + String(yesterday.getDate()).padStart(2,"0");
      document.getElementById("dateHeader").innerText = "Pivot Date: " + formattedYesterday + " | Today: " + formattedToday;

      (async function loop() {
        await updateSlider();
        setTimeout(loop, 5000); // refresh every 5 seconds
      })();
    });

    function resetAlerts() {
      firedAlerts.clear();
      const alertsTable = document.getElementById("alertsTable");
      alertsTable.innerHTML = "<tr><th>Ticker</th><th>Level</th><th>Price</th><th>Time</th></tr>";
    }
  </script>
</body>
</html>
